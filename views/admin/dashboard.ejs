<input type="hidden" id="filter" value="<%= filter || 'daily' %>">

<section class="space-y-6 max-w-7xl mx-auto">
  <div class="bg-white shadow-sm rounded-xl p-4 sm:p-6 border border-[color:var(--color-border)]">
    <h1 class="text-2xl sm:text-3xl font-bold text-[color:var(--color-fg)] mb-4">Admin Dashboard</h1>
    <% if (error) { %>
      <div class="mb-4 p-4 bg-red-100 text-red-700 rounded-md text-sm">
        <%= error %>
      </div>
    <% } %>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="p-4 rounded-xl border border-[color:var(--color-border)] bg-[color:var(--color-primary)]/10">
        <h3 class="text-sm font-semibold text-slate-700">Total Orders</h3>
        <p class="text-2xl font-bold text-slate-900"><%= totalOrders || 0 %></p>
      </div>
      <div class="p-4 rounded-xl border border-[color:var(--color-border)] bg-[color:var(--color-primary)]/10">
        <h3 class="text-sm font-semibold text-slate-700">Total Revenue</h3>
        <p class="text-2xl font-bold text-slate-900">₹<%= Number(totalRevenue || 0).toFixed(2) %></p>
      </div>
      <div class="p-4 rounded-xl border border-[color:var(--color-border)] bg-[color:var(--color-primary)]/10">
        <h3 class="text-sm font-semibold text-slate-700">Total Products</h3>
        <p class="text-2xl font-bold text-slate-900"><%= totalProducts || 0 %></p>
      </div>
      <div class="p-4 rounded-xl border border-[color:var(--color-border)] bg-[color:var(--color-primary)]/10">
        <h3 class="text-sm font-semibold text-slate-700">Total Categories</h3>
        <p class="text-2xl font-bold text-slate-900"><%= totalCategories || 0 %></p>
      </div>
    </div>
  </div>

  <div class="bg-white shadow-sm rounded-xl p-4 sm:p-6 border border-[color:var(--color-border)]">
    <h2 class="text-lg sm:text-xl font-semibold text-[color:var(--color-fg)] mb-3">Filter Revenue Data</h2>
    <div class="flex flex-wrap gap-2 mb-3">
      <% const mkBtn = (key, label) => (`
        <button type="button"
          class="px-3 sm:px-4 py-2 text-sm rounded-lg border border-[color:var(--color-border)] ${filter === key ? 'bg-[color:var(--color-primary)] text-slate-900' : 'bg-gray-50 hover:bg-gray-100 text-slate-700'}"
          onclick="setFilter('${key}')">${label}</button>`); %>
      <%- mkBtn('daily', 'Daily') %>
      <%- mkBtn('weekly', 'Weekly') %>
      <%- mkBtn('monthly', 'Monthly') %>
      <%- mkBtn('yearly', 'Yearly') %>
      <%- mkBtn('custom', 'Custom') %>
    </div>

    <div id="custom-date" class="flex flex-col sm:flex-row gap-4 <%= filter === 'custom' ? '' : 'hidden' %>">
      <div class="w-full sm:w-auto">
        <label for="startDate" class="block text-xs font-medium text-slate-700">Start Date</label>
        <input type="date" id="startDate" name="startDate" value="<%= startDate || '' %>"
               class="mt-1 block w-full rounded-md border border-[color:var(--color-border)] bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary)]">
      </div>
      <div class="w-full sm:w-auto">
        <label for="endDate" class="block text-xs font-medium text-slate-700">End Date</label>
        <input type="date" id="endDate" name="endDate" value="<%= endDate || '' %>"
               class="mt-1 block w-full rounded-md border border-[color:var(--color-border)] bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary)]">
      </div>
      <button type="button" id="applyFilterBtn"
              class="rounded-lg bg-[color:var(--color-primary)] px-4 py-2 text-sm font-medium text-slate-900 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary)] mt-2 sm:mt-6"
              onclick="applyFilter()">
        Apply Filter
      </button>
    </div>
  </div>

  <div class="bg-white shadow-sm rounded-xl p-4 sm:p-6 border border-[color:var(--color-border)]">
    <h2 class="text-lg sm:text-xl font-semibold text-[color:var(--color-fg)] mb-3">Revenue Over Time</h2>
    <div class="relative h-64 sm:h-80">
      <canvas id="revenueChart" class="w-full h-full"></canvas>
      <% if (!chartLabels || chartLabels.length === 0) { %>
        <div class="absolute inset-0 flex items-center justify-center text-sm text-slate-500">
          No revenue data available for the selected period
        </div>
      <% } %>
    </div>
  </div>

  <div class="bg-white shadow-sm rounded-xl p-4 sm:p-6 border border-[color:var(--color-border)]">
    <h2 class="text-lg sm:text-xl font-semibold text-[color:var(--color-fg)] mb-3">Top 10 Best-Selling Products</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-[color:var(--color-border)]">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Product Name</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Quantity Sold</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-[color:var(--color-border)]">
          <% if (topProducts && topProducts.length > 0) { %>
            <% topProducts.forEach(product => { %>
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-slate-900"><%= product.name || 'N/A' %></td>
                <td class="px-4 py-3 text-sm text-slate-900"><%= product.totalSold || 0 %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="2" class="px-4 py-6 text-sm text-slate-500 text-center">No data available</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="bg-white shadow-sm rounded-xl p-4 sm:p-6 border border-[color:var(--color-border)]">
    <h2 class="text-lg sm:text-xl font-semibold text-[color:var(--color-fg)] mb-3">Top 10 Best-Selling Categories</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-[color:var(--color-border)]">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Category Name</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Quantity Sold</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-[color:var(--color-border)]">
          <% if (topCategories && topCategories.length > 0) { %>
            <% topCategories.forEach(category => { %>
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-slate-900"><%= category.name || 'N/A' %></td>
                <td class="px-4 py-3 text-sm text-slate-900"><%= category.totalSold || 0 %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="2" class="px-4 py-6 text-sm text-slate-500 text-center">No data available</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="bg-white shadow-sm rounded-xl p-4 sm:p-6 border border-[color:var(--color-border)]">
    <h2 class="text-lg sm:text-xl font-semibold text-[color:var(--color-fg)] mb-3">Top 10 Best-Selling Brands</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-[color:var(--color-border)]">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Brand Name</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">Quantity Sold</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-[color:var(--color-border)]">
          <% if (topBrands && topBrands.length > 0) { %>
            <% topBrands.forEach(brand => { %>
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-slate-900"><%= brand.name || 'N/A' %></td>
                <td class="px-4 py-3 text-sm text-slate-900"><%= brand.totalSold || 0 %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="2" class="px-4 py-6 text-sm text-slate-500 text-center">No data available</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  const labels = <%- JSON.stringify(chartLabels || []) %>;
  const values = <%- JSON.stringify(chartValues || []) %>;
  const filterLabel = "<%= (filter && filter.charAt) ? (filter.charAt(0).toUpperCase() + filter.slice(1)) : 'Daily' %>";

  const ctx = document.getElementById('revenueChart');
  if (ctx && labels.length > 0 && values.length > 0) {
    new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Revenue (₹)',
          data: values,
          backgroundColor: 'rgba(160,216,216,0.6)',
          borderColor: 'rgb(160,216,216)',
          borderWidth: 2,
          borderRadius: 6,
          barThickness: 20,
          hoverBackgroundColor: 'rgba(160,216,216,0.8)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 800, easing: 'easeInOutQuad' },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Revenue (₹)' },
            ticks: { color: '#475569' },
            grid: { color: '#e5e7eb' }
          },
          x: {
            title: { display: true, text: filterLabel + ' Period' },
            ticks: { color: '#475569' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: '#ffffff',
            titleColor: '#0f172a',
            bodyColor: '#475569',
            borderColor: '#e5e7eb',
            borderWidth: 1,
            displayColors: false,
            callbacks: {
              label: (ctx) => `₹${Number(ctx.raw || 0).toLocaleString()}`
            }
          }
        }
      }
    });
  }

  function setFilter(filterType) {
    const filterEl = document.getElementById('filter');
    const customDateDiv = document.getElementById('custom-date');
    if (!filterEl) {
      showAlert('Error: Filter element not found');
      return;
    }
    filterEl.value = filterType;
    if (customDateDiv) {
      customDateDiv.classList.toggle('hidden', filterType !== 'custom');
    }
    if (filterType !== 'custom') {
      showAlert('Filter applied');
      applyFilter();
    }
  }

  function applyFilter() {
    const filter = document.getElementById('filter')?.value || 'daily';
    const startDate = document.getElementById('startDate')?.value;
    const endDate = document.getElementById('endDate')?.value;
    let url = '/admin/dashboard?filter=' + encodeURIComponent(filter);
    if (filter === 'custom') {
      if (!startDate || !endDate) {
        showAlert('Please select both start and end dates');
        return;
      }
      if (new Date(endDate) < new Date(startDate)) {
        showAlert('End date cannot be before start date');
        return;
      }
      url += '&startDate=' + encodeURIComponent(startDate) + '&endDate=' + encodeURIComponent(endDate);
    }
    showAlert('Filter applied');
    window.location.href = url;
  }

  function showAlert(text) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-[color:var(--color-primary)] text-slate-900 px-4 py-2 rounded-md shadow-lg opacity-0 transition-opacity duration-300 z-50';
    alertDiv.textContent = text || 'Action successful';
    document.body.appendChild(alertDiv);
    requestAnimationFrame(() => { alertDiv.style.opacity = '1'; });
    setTimeout(() => {
      alertDiv.style.opacity = '0';
      setTimeout(() => {
        if (alertDiv.parentNode) {
          document.body.removeChild(alertDiv);
        }
      }, 300);
    }, 1400);
  }
</script>